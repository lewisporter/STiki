package utilities;

import core_objects.metadata;
import db_server.db_geolocation;
import db_server.stiki_con_server;
import mediawiki_api.api_retrieve;

/**
 * Andrew G. West - util_edit_duration.java - A utility used to measure how
 * long an edit (or set thereof) was active on Wikipedia.
 */
public class util_edit_duration {

	// **************************** PRIVATE FIELDS ***************************

	/**
	 * Set of edits to be processed. The current list contains the 1000
	 * worst-scoring edits as of 2010/05/05
	 */
	private static long[] edit_rids = {350882316, 357013094, 359735553, 351102119,
			357290303, 357290292, 355579590, 359294759, 346806172, 358540288,
			358329479, 357163815, 357163827, 357163829, 357163820, 357163817,
			350881755, 357882464, 355840467, 358539459, 354360012, 355826065,
			355654527, 356075806, 359097723, 354730022, 357322341, 356269220,
			358980924, 353034164, 352235295, 352235293, 358273159, 359715773,
			355163057, 357323174, 358422667, 358468439, 358468444, 354709999,
			356186418, 355886656, 357059676, 352516517, 356956895, 352505689,
			358384758, 350174224, 347345331, 347345045, 352517119, 355878572,
			351410494, 351431067, 346929456, 350182898, 351410371, 352515082,
			352289199, 352506471, 350186788, 350741199, 350360359, 352460999,
			352520371, 352460535, 352460316, 352468659, 352108730, 351410086,
			352516734, 347770401, 346986021, 351944202, 359431624, 359423410,
			347744084, 352830997, 359148212, 350889619, 350983367, 352461359,
			347743935, 357466793, 352500498, 347938448, 346905770, 346961573,
			347134122, 347930811, 350164223, 346908536, 350723036, 347930628,
			359595359, 359595354, 359595375, 359595365, 359595348, 347769360,
			346961409, 354620067, 350983148, 347769769, 350982024, 347347292,
			352507615, 359410705, 352825206, 350163156, 350163082, 350983453,
			352516873, 349534802, 347918885, 359222804, 351409870, 357467882,
			352509578, 347350259, 352522429, 359907445, 346995281, 346995396,
			357044803, 352515444, 357029461, 352826171, 347346537, 354213345,
			346902634, 351878549, 350983439, 347743851, 352514008, 347152983,
			352084873, 350178495, 352248088, 352051173, 347068402, 347743894,
			347068566, 350178524, 347742665, 360025096, 347001144, 350178726,
			357802418, 350730061, 352512513, 347743703, 359947967, 348673099,
			352512521, 352512578, 350746261, 347918487, 356643148, 356133660,
			359449912, 353781254, 347131701, 351428166, 347930433, 352521770,
			346961175, 359446317, 347083811, 356077301, 358903555, 358143846,
			357800280, 357913126, 352519177, 352518781, 352519520, 352519277,
			352460793, 352518583, 352082208, 347915333, 357532312, 359758852,
			359758934, 347140407, 359464908, 352090477, 358092468, 352515726,
			355676654, 359377616, 350165969, 350165890, 352518308, 353798721,
			352505796, 355416508, 352517288, 347240619, 347131658, 352082116,
			346824802, 352514623, 352514357, 352514467, 353755492, 350740219,
			351925343, 346820843, 349487661, 350740804, 352513927, 349240839,
			359421624, 352076989, 350999255, 350998960, 359435001, 358864196,
			352513517, 351000108, 354092029, 359932117, 352051771, 349500493,
			352513260, 350825265, 352247980, 352513051, 351009184, 352074216,
			350575219, 352834896, 347917124, 347000933, 352513562, 359637449,
			352512352, 352516086, 354885981, 352051545, 359943859, 347083415,
			359941304, 347153797, 347916712, 347916950, 347917071, 347153228,
			347744068, 353756307, 359945049, 352089544, 347917444, 352517969,
			351852801, 348197424, 347818785, 347379345, 347154666, 351853601,
			352515045, 358879885, 356081850, 350740843, 347153392, 351286935,
			346961075, 352518135, 347917669, 350377512, 349899714, 352520697,
			352513809, 357063788, 352520435, 351286732, 352512964, 347917587,
			356019867, 352520342, 357458679, 352519656, 352511870, 359393867,
			353383823, 347917287, 348565864, 352515217, 357806423, 351872903,
			355718242, 352210419, 357046007, 357579184, 355946745, 357899950,
			353805020, 351909122, 356018279, 356124466, 352514012, 351439722,
			347918638, 354328348, 357799724, 357188523, 355662872, 349739706,
			350375817, 352081463, 352081394, 352518292, 346914247, 350540142,
			347930256, 347930336, 347151253, 352066843, 351852963, 354777893,
			352498343, 354884306, 347917739, 352729623, 352521190, 348470229,
			359458181, 352512009, 356096814, 347935835, 359448543, 359448620,
			359941606, 359937541, 358072975, 352085515, 359450233, 354634775,
			359395450, 352510036, 349469666, 359882594, 347933059, 359366349,
			352517030, 354987410, 352066939, 352465839, 352517114, 357669273,
			352518463, 360008394, 358898054, 347142774, 347510839, 346961002,
			350977329, 355701348, 359376969, 356712931, 351898967, 357001746,
			352517745, 359947315, 355963856, 355680494, 347241173, 346714484,
			352518022, 356059062, 354249195, 360275613, 353301395, 351744783,
			352509922, 353645663, 353824314, 357526168, 352510141, 352082406,
			347002589, 358894755, 347352024, 355724668, 359488710, 354391871,
			356270370, 347358330, 351953676, 356009184, 349488923, 355298717,
			357051610, 347153719, 352518950, 347932103, 351857796, 359710116,
			359879825, 350354086, 346987837, 354772823, 352065351, 350712655,
			354359449, 352516480, 357533566, 354692209, 355519301, 351228788,
			359446205, 360025415, 350977023, 352069378, 355676082, 350179012,
			358909753, 346818808, 358537962, 346983629, 359417444, 352511221,
			358521201, 356087414, 347085931, 353061843, 346715550, 351064110,
			359450432, 346715497, 359949554, 352007624, 352523007, 358532135,
			359433779, 357038807, 359707763, 352519186, 352518636, 352499192,
			352511006, 359646990, 347084617, 346918319, 357913495, 350745361,
			354249191, 358488954, 350168995, 347243017, 357994630, 359177026,
			351233561, 349757259, 347084154, 347084110, 348260396, 350397391,
			355369736, 346599545, 354348635, 352282111, 350588296, 352512738,
			356139230, 352067173, 358848219, 358364877, 358538355, 353801215,
			353059536, 355559557, 347153802, 356007912, 354043964, 350164896,
			352490945, 350998344, 349482909, 350353342, 352077459, 352028801,
			357668970, 358523280, 346599447, 352235504, 355869976, 358927689,
			352502397, 351956433, 357061173, 353386490, 347242269, 359439537,
			351424243, 349367914, 355293921, 355883213, 359308019, 352053424,
			357549727, 357478051, 352078092, 358531496, 357390823, 359403584,
			357552422, 354359085, 358517574, 351249312, 353016152, 348697976,
			347955730, 351373543, 347349123, 353831718, 356887725, 357481022,
			351149837, 359203287, 360154852, 354038348, 357377966, 356674263,
			359244841, 357049014, 359459063, 346634072, 353050338, 351142332,
			352518104, 352816787, 348891218, 352515564, 359799016, 352523936,
			347952395, 351988596, 357044921, 350178109, 354556045, 359951649,
			346730632, 359200437, 347181813, 359693987, 359067840, 359405343,
			350920521, 351971425, 354431827, 357043177, 351414295, 358546245,
			356206547, 353286229, 346960928, 356057741, 359332956, 355695492,
			359936380, 350984221, 358617580, 347066666, 355643918, 347093882,
			351988967, 350185495, 352515702, 356006233, 351071606, 356050002,
			350171981, 359443209, 348472105, 359952029, 351371843, 352512524,
			357955707, 352250640, 351140897, 350178080, 352078222, 355633566,
			355665555, 349447012, 351085568, 351796308, 351970529, 353127235,
			355865510, 352069992, 358531691, 349684081, 356007537, 359379067,
			354327055, 357783965, 352515377, 349497429, 355662949, 355783845,
			351373626, 354906133, 351148538, 351759037, 347959748, 347344389,
			347959191, 360020556, 347344058, 357172101, 357810222, 347061717,
			350177644, 351086272, 359335467, 352486074, 355787483, 351086081,
			347057252, 354473595, 357368221, 347085178, 355125324, 352509667,
			357902263, 350376667, 354235445, 352524359, 357024870, 354939104,
			355423471, 357033737, 354373454, 350988163, 358519660, 352196850,
			355226659, 352726538, 351138058, 357798993, 359431847, 357103324,
			354914030, 349476260, 354937999, 355733824, 348266595, 354271594,
			357466979, 354156070, 357368281, 356703855, 359940113, 355660551,
			347066617, 356281478, 352466289, 354771699, 359938050, 354990930,
			356159456, 346988676, 350540816, 351765932, 352519128, 356160577,
			352246794, 350355931, 352302981, 359939200, 355930228, 357075997,
			350899461, 358912775, 351051462, 354914687, 357075739, 358232646,
			346989238, 359697472, 351758849, 350963587, 355087607, 357394649,
			356771141, 351303341, 352246433, 359393405, 352066029, 354931421,
			346989400, 352514030, 349480655, 354332195, 359948194, 358523394,
			357622343, 352517278, 350541363, 356023796, 351858327, 353079517,
			352466188, 346930554, 355783805, 348890071, 353820318, 354883801,
			358852256, 351233713, 351591575, 349925911, 347340147, 358986187,
			357362953, 350919206, 359382218, 346910427, 353307586, 355692752,
			351759583, 356007210, 354601581, 356518025, 359874387, 358562375,
			355634307, 357391066, 357510692, 354907603, 358885827, 357315891,
			356916383, 356040921, 352236076, 351837626, 354771226, 354977607,
			358923710, 359219229, 352293014, 352081060, 352524860, 352517418,
			358526293, 356903222, 351410743, 351759107, 347816222, 359406195,
			359386059, 355671694, 352258381, 358356344, 354235334, 352523119,
			348669360, 352463916, 358544754, 358928488, 359299880, 355894476,
			357354403, 358851288, 349547599, 357709043, 353221646, 352320513,
			358516241, 356521750, 360029580, 347085257, 352073903, 346959831,
			352455295, 357710576, 354937068, 359335476, 349447842, 357182165,
			347513295, 353037181, 351414425, 353238737, 355666489, 354912303,
			357581556, 359295286, 354228794, 351148302, 354982427, 347741956,
			359947667, 359982427, 356532537, 353080785, 354345686, 357694993,
			352834744, 346978688, 351368603, 358885623, 351759236, 347920111,
			351141145, 358531547, 352058541, 354969997, 355646387, 359954763,
			357219780, 349473023, 356574229, 354225389, 355658315, 357062522,
			355657706, 358620787, 355471717, 355875074, 359439147, 347083395,
			351437653, 359106267, 350184034, 352507034, 359578959, 351758906,
			355298635, 351758978, 352522749, 352507084, 349921312, 356607238,
			359508636, 355132612, 352513243, 353801279, 359025785, 350055056,
			351445892, 347243772, 359942326, 354869362, 352514918, 350060686,
			352977057, 347132010, 347931736, 360018913, 359277990, 357506473,
			356023116, 352514817, 360205514, 347729657, 355771377, 359440785,
			351414556, 359949563, 352449948, 350979104, 346826808, 352458461,
			347375856, 351140802, 355582329, 351148235, 358517771, 352764540,
			357083351, 347968371, 357191507, 348741807, 353843039, 351017882,
			352449702, 352896602, 360129127, 349552604, 354419849, 351773583,
			352064580, 355772134, 359712924, 357478177, 357489806, 356170589,
			358536779, 347132264, 359947001, 351858129, 359508523, 354601480,
			359399479, 346730302, 354535640, 352523461, 358529677, 356597833,
			347131984, 352523667, 353837650, 359697734, 354815713, 350665346,
			357390674, 357480483, 356189421, 359018834, 351943976, 357090223,
			358888547, 347346594, 359466551, 355399105, 355423620, 347947154,
			354352479, 351135910, 354530202, 356890289, 353301461, 350176477,
			355738975, 360234998, 355660736, 357325531, 351222170, 357477578,
			347149194, 352586091, 357033355, 355138410, 356007657, 357029171,
			355715463, 359334021, 346953126, 357787956, 350165814, 350176843,
			349305373, 346953864, 359934602, 359282696, 357526733, 359012599,
			349176085, 355861628, 359495682, 355691742, 359377807, 358922651,
			356233697, 357786337, 350583140, 359364008, 349489499, 358933233,
			355659681, 352130886, 357066262, 355619913, 358077307, 355574809,
			359841469, 358302794, 355827809, 348706679, 359936263, 350054573,
			356179321, 351299196, 352084277, 352464868, 359776874, 355633059,
			354869157, 357481852, 349912109, 349759125, 351748597, 356057473,
			349744777, 359460461, 359914933, 358782748, 359212953, 358923561,
			351858019, 350708697, 352064378, 356608552, 354452836, 357870119};


	// **************************** PUBLIC METHODS ***************************

	/**
	 * Compute the avg. time a set of edits were/have-been active on Wikipedia.
	 *
	 * @param args No arguments are required by this method.
	 */
	public static void main(String[] args) throws Exception {

		stiki_con_server con_server = new stiki_con_server();
		db_geolocation db_geo = new db_geolocation(con_server);

		long edits_counted = 0;    // Total number of edits processed
		long duration_sum = 0;    // Sum of all edit durations
		long duration = 0;        // Active duration of last edit processed

		for (int i = 0; i < edit_rids.length; i++) {
			try {
				duration = time_edit_active(edit_rids[i], db_geo);
				System.out.println("RID " + edit_rids[i] + " active for " +
						duration + " seconds");
				duration_sum += duration;
				edits_counted++;
			} catch (Exception e) {
			} // Non-critical, just skip any errors
		} // Iterate over all edits in the provided set

		// Print average for all edits in set
		double average = ((duration_sum * 1.0) / (edits_counted * 1.0));
		System.out.println("Average duration for set: " + average);

		// Close up and shut-down
		db_geo.shutdown();
		con_server.con.close();
	}

	/**
	 * Compute the time, in seconds, that an edit was (if no longer active),
	 * or has-been (if currently active) active on Wikipedia.
	 *
	 * @param rid    Revision-ID of the edit under investigation
	 * @param db_geo Geolocation handler required for metadata-fetching
	 * @return Time, in seconds, that 'rid' was/has-been active
	 */
	public static long time_edit_active(long rid, db_geolocation db_geo)
			throws Exception {

		// Get metadata (includes edit-ts, and article made on)
		metadata md = api_retrieve.process_basic_rid(rid, db_geo);
		long next_ts = api_retrieve.process_next_page_edit_ts(md.pid, rid);

		if (next_ts != -1) // If there is a next edit
			return (next_ts - md.timestamp);
		else { // If edit under inspection is the most current
			long prev_ts = api_retrieve.process_prior_page_edit_ts(md.pid, rid);
			if (prev_ts != -1)
				return (md.timestamp - prev_ts);
			else return 0; // If edit is the ONLY one for page, default to 0
		} // Location of edit in page-history determines compute path
	}

}
